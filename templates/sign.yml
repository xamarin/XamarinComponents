parameters:
  dependsOn: 'build'
  signTags: True
  forceSignVariable: 'CodeSign'
  additionalConditions: False

resources:
  repositories:
    - repository: xamarin-templates
      type: github
      name: xamarin/yaml-templates
      endpoint: xamarin

jobs:
  - ${{ if eq(variables['System.TeamProject'], 'devdiv') }}:
    - job: signing
      displayName: 'Sign NuGets'
      variables:
        skipComponentGovernanceDetection: true
      dependsOn:
        - ${{ parameters.dependsOn }}
      pool:
        name: VSEng-XamarinCustom
        demands:
          - corpnet
      condition: and(
        succeeded(),
        or(
          and(
            eq('${{ parameters.signTags }}', True),
            startsWith(variables['Build.SourceBranch'], 'refs/tags/')
          ),
          and(
            ne('${{ parameters.forceSignVariable }}', ''),
            eq(variables['${{ parameters.forceSignVariable }}'], True)
          ),
          eq('${{ parameters.additionalConditions }}', True)
        ))
      steps:
        - checkout: none
        - template: sign-artifacts.yml@xamarin-templates
          parameters:
            targetFolder: '$(Build.ArtifactStagingDirectory)/signed'
        - task: PublishBuildArtifacts@1
          displayName: 'Publish the nuget-signed artifacts'
          inputs:
            artifactName: nuget-signed
            pathToPublish: '$(Build.ArtifactStagingDirectory)/signed'
